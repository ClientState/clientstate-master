// Generated by CoffeeScript 1.8.0
(function() {
  'use strict';
  var CSMController;

  window.CSMApp = angular.module('CSMApp', ['ngStorage']);

  CSMApp.filter('Objectkeys', function() {
    return function(input) {
      return Object.keys(input);
    };
  });

  CSMController = function($scope, $http, $localStorage) {
    var init;
    window.scope = $scope;
    $scope.$storage = $localStorage;
    $scope.clientid = "b6d50cdc7d9372561081";
    $scope.ack_token = function() {
      $http.defaults.headers.common.access_token = $scope.$storage.github_access_token;
      return $scope.get_apps();
    };
    $scope.logout = function() {
      return $scope.$storage.github_access_token = void 0;
    };
    $scope.github_login = function() {
      OAuth.initialize($scope.clientid);
      OAuth.setOAuthdURL(window.location.origin);
      OAuth.popup("github", function(err, provider_data) {
        if (err != null) {
          console.log(err.stack);
        }
        $scope.$storage.github_access_token = provider_data.access_token;
        return $scope.ack_token();
      });
    };
    $scope.get_apps = function(cb) {
      if (cb == null) {
        cb = function() {};
      }
      return $http.get('/apps').success(function(res) {
        $scope.apps = res;
        return cb();
      });
    };
    $scope.create_new_app = function(cb) {
      if (cb == null) {
        cb = function() {};
      }
      return $http.post('/apps', {
        name: $scope.newAppName
      }).success(function(res) {
        $scope.newAppName = "";
        return $scope.get_apps(cb);
      });
    };
    $scope.save_app = function(app) {
      return $http.put("/apps/" + app.id, {
        name: app.name
      }).success(function(res) {
        return $scope.get_apps(function() {
          return alert("Successfully Saved!");
        });
      });
    };
    $scope.create_service = function(type, app_id) {
      return $http.post("/apps/" + app_id + "/services", {
        type: type
      }).success(function(res) {
        return $scope.get_apps();
      });
    };
    $scope.delete_service = function(service) {
      return $http["delete"]("/apps/" + service.app_id + "/services/" + service.id).success(function(res) {
        return $scope.get_apps();
      });
    };
    $scope.create_pis = function(app) {
      var d;
      d = {
        provider: "github",
        client_id: app.new_client_id,
        client_secret: app.new_client_secret,
        oauth_redirect_url: app.new_oauth_redirect_url
      };
      return $http.post("/apps/" + app.id + "/provider-id-secrets", d).then(function(res) {
        return $scope.get_apps();
      });
    };
    init = function() {
      if ($scope.$storage.github_access_token != null) {
        return $scope.ack_token();
      }
    };
    return init();
  };

  CSMController.$inject = ['$scope', '$http', '$localStorage'];

  angular.module('CSMApp').controller('CSMController', CSMController);

}).call(this);
